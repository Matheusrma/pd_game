<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 5</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(600, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {
    game.load.image('back', 'assets/back.png');
    game.load.image('header', 'assets/header.png');
    game.load.image('archive', 'assets/archive.png'); //32x32
    game.load.image('beer', 'assets/beer.png'); //32x32
    game.load.image('playerAvatar', 'assets/player.png'); //64x64
}

function Player(entinty, speed, accel){
    this.entinty = entinty;
    this.speed = speed;
    this.accel = accel;

    game.physics.arcade.enable(this.entinty);

    this.entinty.body.gravity.y = 0;
    this.entinty.body.collideWorldBounds = true;

    this.move = function(cursors){
        this.entinty.body.velocity.x = 0;
     
        if (cursors.left.isDown) {
            this.entinty.body.velocity.x = -this.speed;
        }
        else if (cursors.right.isDown) {
            this.entinty.body.velocity.x = this.speed;
        }
    }
}

function CollectableSpawner(group, spawnDelay, collectableSpeed, minSpeed, distractionRate){
    var _lastArchiveSpawn = 0;
    var _spawnDelay = spawnDelay;
    var _collectableSpeed = collectableSpeed;
    var _minSpeed = minSpeed;

    var _group = group;

    var _distractionRate = distractionRate;

    this.spawn = function(period){
        if (game.time.time - _lastArchiveSpawn < _spawnDelay ) return;

        _lastArchiveSpawn = game.time.time;

        if (Math.random() < _distractionRate[period]){
            spawnTrouble();
        }
        else{
            spawnArchive(); 
        }
    }

    var spawnArchive = function(){
        var spawnX = Math.max(0, Math.min(Math.random() * game.world.width , game.world.width - 32));

        var archive = _group.create(spawnX, headerHeight + 16, 'archive');
        archive.body.velocity.y += Math.max(_minSpeed, Math.random() * _collectableSpeed);  
    }

    var spawnTrouble = function(){
        var spawnX = Math.max(0, Math.min(Math.random() * game.world.width , game.world.width - 32));

        var archive = _group.create(spawnX, headerHeight + 16, 'beer');
        archive.body.velocity.y += Math.max(_minSpeed, Math.random() * _collectableSpeed);
    }
}

var player;

var collectables;
var archiveCount = 0;

var collectableSpawner;

var headerHeight = 30;

var currentPeriod = 0;

var periodTarget = [10,10,10,10,10,10,10,10,10,10];
var periodDistractionRates = [0.3,0.25,0.3,0.4,0.35,0.45,0.5,0.55,0.6,0.6];

var archiveText;
var scoreText;
var periodText;

function create() {
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.add.sprite(0, 0, 'back');

    var topHeader = game.add.sprite(0, 0, 'header');
    topHeader.bringToTop();

    var bottomHeader = game.add.sprite(0, game.world.height - 30, 'header');
    bottomHeader.bringToTop();

    var font = { font: '14px Helvetica', fill: '#FFF' , fontWeight:'500' };
    var textY = game.world.height - 24;

    scoreText  = game.add.text(game.world.width - 85, textY, 'Pontos: 0', font);

    archiveText  = game.add.text(8, textY, '0/' + periodTarget[0] + ' arquivos',  font);

    periodText = game.add.text(260, textY, 'Calouro', font);

    collectables = game.add.group();
    collectables.enableBody = true;

    var playerSprite = game.add.sprite(game.world.width/2 - 32, game.world.height - 64 - headerHeight, 'playerAvatar');
    player = new Player(playerSprite, 200, 0);

    collectableSpawner = new CollectableSpawner(collectables, 400, 150, 100, periodDistractionRates);
}

function update() {
    game.physics.arcade.overlap(player.entinty, collectables, collect, null, this);

    player.move(game.input.keyboard.createCursorKeys());

    collectableSpawner.spawn(currentPeriod);
}

var collect = function(player, collectable){
    if (collectable.key == 'archive'){
        collectable.kill();

        archiveCount++;

        if (archiveCount >= periodTarget[currentPeriod]){
            currentPeriod++;

            if (currentPeriod < periodTarget.length - 1){
                periodText.text = currentPeriod + 1 +'ยบ periodo';          
            }
            else if (currentPeriod == periodTarget.length - 1){
                periodText.text = 'Formando';             
            }    
            else{
                gameEnd(true); 
                return;
            }

            archiveCount = 0;   
        }
        scoreText.text = 'Pontos: ' + archiveCount * 100 + currentPeriod + 1000;
        archiveText.text = archiveCount + '/' + periodTarget[currentPeriod] + ' arquivos';
    }
    else{
        player.kill();
        gameEnd(false);      
    }
}

var gameEnd = function(win){
    console.log('YOU LOSE ' + win);
}

</script>

</body>
</html>