<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 5</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(600, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {
    game.load.image('back', 'assets/back.png');
    game.load.image('header', 'assets/header.png');
    game.load.image('star', 'assets/star.png'); //24x22
    game.load.image('diamond', 'assets/diamond.png'); //32x28
    game.load.image('playerAvatar', 'assets/player.png'); //64x64
}

function Player(entinty, speed, accel){
    this.entinty = entinty;
    this.speed = speed;
    this.accel = accel;

    game.physics.arcade.enable(this.entinty);

    this.entinty.body.bounce.y = 0.2;
    this.entinty.body.gravity.y = 300;
    this.entinty.body.collideWorldBounds = true;

    this.move = function(cursors){
        this.entinty.body.velocity.x = 0;
     
        if (cursors.left.isDown) {
            this.entinty.body.velocity.x = -this.speed;
        }
        else if (cursors.right.isDown) {
            this.entinty.body.velocity.x = this.speed;
        }
    }
}

function CollectableSpawner(group, spawnDelay, collectableSpeed, minSpeed){
    var _lastArchiveSpawn = 0;
    var _spawnDelay = spawnDelay;
    var _collectableSpeed = collectableSpeed;
    var _minSpeed = minSpeed;

    var _group = group;

    this.spawn = function(){
        if (game.time.time - _lastArchiveSpawn < _spawnDelay ) return;

        _lastArchiveSpawn = game.time.time;

        if (Math.random() < 0.3){
            spawnTrouble();
        }
        else{
            spawnArchive(); 
        }
    }

    var spawnArchive = function(){
        var spawnX = Math.max(0, Math.min(Math.random() * game.world.width , game.world.width - 24));

        var archive = _group.create(spawnX, headerHeight + 12, 'star');
        archive.body.velocity.y += Math.max(_minSpeed, Math.random() * _collectableSpeed);  
    }

    var spawnTrouble = function(){
        var spawnX = Math.max(0, Math.min(Math.random() * game.world.width , game.world.width - 32));

        var archive = _group.create(spawnX, headerHeight + 14, 'diamond');
        archive.body.velocity.y += Math.max(_minSpeed, Math.random() * _collectableSpeed);
    }
}

var player;

var collectables;
var archiveCount = 0;

var collectableSpawner;

var scoreText;

var headerHeight = 30;

function create() {
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.add.sprite(0, 0, 'back');
    game.add.sprite(0, 0, 'header');

    collectables = game.add.group();
    collectables.enableBody = true;

    var playerSprite = game.add.sprite(game.world.width/2 - 32, game.world.height - 32, 'playerAvatar');
    player = new Player(playerSprite, 200, 0);

    collectableSpawner = new CollectableSpawner(collectables, 300, 100, 50);

    scoreText = game.add.text(8, 8, 'Você baixou 0 arquivos.', { font: '14px Helvetica', fill: '#FFF' });
}

function update() {
    game.physics.arcade.overlap(player.entinty, collectables, collect, null, this);

    player.move(game.input.keyboard.createCursorKeys());

    collectableSpawner.spawn();
}

var collect = function(player, collectable){
    if (collectable.key == 'star'){
        archiveCount++;

        scoreText.text = 'Você baixou ' + archiveCount + ' arquivos.';

        collectable.kill();
    }
    else{
        player.kill();
        gameEnd();      
    }
}

var gameEnd = function(){
    console.log('YOU LOSE');
}

</script>

</body>
</html>